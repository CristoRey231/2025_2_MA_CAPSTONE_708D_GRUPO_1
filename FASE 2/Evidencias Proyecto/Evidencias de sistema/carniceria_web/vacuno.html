<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Productos de Vacuno - Carnes Ttami√±a</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/navbar.css">
  <script type="module" src="js/navbar.js"></script>
  <script type="module" src="js/carritoglobal.js"></script>
  <script src="js/cartSidebar.js" defer></script>
  <link rel="stylesheet" href="carnesStilos.css">
  <link rel="stylesheet" href="css/footer.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="css/cart-sidebar.css">
  
</head>

<body>
<!-- NAVBAR -->
<header class="navbar">
  <div class="navbar-container">

    <!-- LOGO + barra de b√∫squeda -->
    <div class="navbar-left">
      <h1 class="navbar-logo">Carnes Ttami√±a</h1>
      <div class="navbar-search">
        <input type="text" placeholder="Busca aqu√≠ tus productos..." />
        <button><i class="fa fa-search"></i></button>
      </div>
    </div>

    <!-- MEN√ö DE NAVEGACI√ìN -->
    <nav class="navbar-right">
      <ul>
        <li><a href="pag_principal.html"><i class="fa fa-home"></i> Inicio</a></li>

        <li class="dropdown align-right">
          <a href="#"><i class="fa fa-user"></i> Bienvenido</a>
          <ul class="dropdown-menu">
            <li><a href="#"><i class="fa fa-id-card"></i> Mi cuenta</a></li>
            <li><a href="login.html"><i class="fa fa-sign-in-alt"></i> Iniciar sesi√≥n</a></li>
            <li class="no-cuenta">¬øNo tienes cuenta?
              <a href="registro.html" class="crear-cuenta">Cr√©ala aqu√≠</a>
            </li>
          </ul>
        </li>

        <!-- Men√∫ Categor√≠as -->
        <li class="dropdown">
          <a href="#"><i class="fa fa-cut"></i> Categor√≠as <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu">
            <li><a href="vacuno.html">Vacuno</a></li>
            <li><a href="ave.html">Ave</a></li>
            <li><a href="cerdo.html">Cerdo</a></li>
            <li><a href="todo_asado.html">Todo para el asado</a></li>
            <li><a href="packs.html">Packs</a></li>
          </ul>
        </li>

        <!-- Carrito (debe estar dentro del UL) -->
        <li class="cart-icon">
          <a href="carrito.html">
            <i class="fa fa-shopping-cart"></i>
            <span class="cart-count">0</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

  <!-- CATEGOR√çAS -->
  <section class="categorias-destacadas">
    <a href="vacuno.html" class="categoria-boton vacuno">Vacuno</a>
    <a href="ave.html" class="categoria-boton ave">Ave</a>
    <a href="cerdo.html" class="categoria-boton cerdo">Cerdo</a>
    <a href="todo_asado.html" class="categoria-boton todo-asado">Todo para el Asado</a>
    <a href="packs.html" class="categoria-boton packs">Packs</a>
  </section>

  <!-- CONTENIDO -->
  <main class="catalogo-container">
    <div class="breadcrumb">
      <a href="pag_principal.html">Inicio</a> > <strong>Vacuno</strong>
    </div>

    <h1 class="titulo-categoria">üêÑ Cortes de Vacuno</h1>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">
      Descubre nuestra selecci√≥n premium de cortes de res, jugosos y llenos de sabor
    </p>

    <div class="filtros-container">
      <div class="busqueda-vacuno">
        <input type="text" id="busquedaVacuno" placeholder="Buscar en vacuno...">
      </div>
      <select class="filtro-orden" id="filtroOrden">
        <option value="nombre">Ordenar por: Nombre</option>
        <option value="precio_asc">Precio: Menor a Mayor</option>
        <option value="precio_desc">Precio: Mayor a Menor</option>
        <option value="stock">M√°s disponible</option>
      </select>
    </div>

    <!-- Loader -->
    <div class="skeleton-loader" id="skeletonLoader">
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
    </div>

    <div class="productos-grid" id="productosGrid" style="display: none;"></div>

    <div id="sinProductos" class="sin-productos" style="display: none;">
      <i class="fas fa-search"></i>
      <h3>No se encontraron productos de vacuno</h3>
      <p>Intenta con otros t√©rminos de b√∫squeda</p>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-section">
      <h4>Categor√≠as</h4>
      <ul>
        <li><a href="vacuno.html">Vacuno</a></li>
        <li><a href="ave.html">Ave</a></li>
        <li><a href="cerdo.html">Cerdo</a></li>
        <li><a href="todo_asado.html">Todo para el asado</a></li>
        <li><a href="packs.html">Packs</a></li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Servicio al cliente</h4>
      <ul>
        <li>T√©rminos y condiciones</li>
        <li>Cont√°ctanos</li>
        <li>Qui√©nes somos</li>
      </ul>
    </div>

    <div class="footer-section">
      <h4>Horarios</h4>
      <p>Lunes a s√°bado: 09:00 a 18:00 hrs</p>
    </div>

    <div class="footer-section">
      <h4>M√©todos de pago</h4>
      <img src="img/logo-web-pay-plus.png" alt="WebPay Plus" width="100">
    </div>
  </footer>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    import { agregarAlCarrito } from './js/carritoglobal.js'

    const SUPABASE_URL = 'https://bagilcaibwidyewiqqzd.supabase.co'
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhZ2lsY2FpYndpZHlld2lxcXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMjY3NDEsImV4cCI6MjA3NDYwMjc0MX0.VsVsH8c9fpjKxgmuNWYUCqE8e8DDcXicUELTexNJaAU'
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    class ProductosVacuno {
      constructor() {
        this.productos = [];
        this.init();
      }

      async init() {
        await this.cargarProductosVacuno();
        this.setupEventListeners();
      }

      async cargarProductosVacuno() {
        const skeleton = document.getElementById('skeletonLoader');
        const grid = document.getElementById('productosGrid');
        const sinProductos = document.getElementById('sinProductos');

        try {
          // Mantener el skeleton visible hasta que todo cargue
          skeleton.style.display = 'grid';
          grid.style.display = 'none';
          sinProductos.style.display = 'none';

          // ‚úÖ CONSULTA ACTUALIZADA (usa "categoria" como texto, no ID)
          const { data: productos, error } = await supabase
            .from('producto')
            .select('*')
            .eq('categoria', 'vacuno') // <-- texto
            .order('nombre', { ascending: true });

          if (error) throw error;

          console.log('‚úÖ Productos cargados desde Supabase:', productos);

          this.productos = productos || [];

          await new Promise(resolve => setTimeout(resolve, 500)); // peque√±o delay visual

          if (this.productos.length > 0) {
            this.mostrarProductos(this.productos);
            grid.style.display = 'grid';
            sinProductos.style.display = 'none';
          } else {
            grid.style.display = 'none';
            sinProductos.style.display = 'block';
          }

        } catch (error) {
          console.error('Error al cargar los productos:', error);
          this.mostrarError('Error al cargar los productos de vacuno');
        } finally {
          skeleton.style.display = 'none';
        }
      }


      mostrarProductos(productos) {
        const grid = document.getElementById('productosGrid');
        const sinProductos = document.getElementById('sinProductos');
        grid.innerHTML = '';

        if (!productos.length) {
          grid.style.display = 'none';
          sinProductos.style.display = 'block';
          return;
        }

        sinProductos.style.display = 'none';
        grid.style.display = 'grid';

        productos.forEach(producto => {
          const card = this.crearTarjetaProducto(producto);
          grid.appendChild(card);
        });
      }

      crearTarjetaProducto(producto) {
        const card = document.createElement('div');
        card.className = 'producto-card';
        
        const precioFormateado = new Intl.NumberFormat('es-CL', {
          style: 'currency',
          currency: 'CLP'
        }).format(producto.precio);

        const disponible = producto.stock > 0;

        card.innerHTML = `
          <div class="imagen-container">
            <img src="${producto.imagen_url || 'img/placeholder-producto.jpg'}"
                 alt="${producto.nombre}"
                 class="producto-imagen"
                 onerror="this.src='img/placeholder-producto.jpg'">

            ${
              disponible
                ? `<button class="btn-flotante" data-id="${producto.producto_id}">
                     <i class="fas fa-cart-plus"></i> Agregar al Carrito
                   </button>`
                : `<button class="btn-flotante" disabled>
                     <i class="fas fa-times"></i> No disponible
                   </button>`
            }
          </div>

          <div class="producto-nombre">${producto.nombre}</div>
          <div class="producto-descripcion">${producto.descripcion || 'Corte premium de vacuno'}</div>
          <div class="producto-precio">${precioFormateado}</div>
          <div class="producto-unidad">/${producto.unidad || 'kg'}</div>

          ${
            disponible
              ? `<div class="producto-stock">
                   <i class="fas fa-check-circle"></i> Stock: ${producto.stock} ${producto.unidad || 'un'}
                 </div>`
              : `<div class="producto-agotado">
                   <i class="fas fa-times-circle"></i> Agotado
                 </div>`
          }
        `;

        // ‚ö†Ô∏è CAMBIO 3: Conectar con el carrito global
        const boton = card.querySelector('.btn-flotante');
        if (boton && disponible) {
          boton.addEventListener('click', () => {
            agregarAlCarrito(producto);
            boton.innerHTML = '<i class="fas fa-check"></i> ¬°Agregado!';
            boton.disabled = true;
            setTimeout(() => {
              boton.innerHTML = '<i class="fas fa-cart-plus"></i> Agregar al Carrito';
              boton.disabled = false;
            }, 1500);
          });
        }

        return card;
      }

      setupEventListeners() {
        document.getElementById('busquedaVacuno').addEventListener('input', () => this.filtrarProductos());
        document.getElementById('filtroOrden').addEventListener('change', () => this.filtrarProductos());
      }

      filtrarProductos() {
        const busqueda = document.getElementById('busquedaVacuno').value.toLowerCase();
        const orden = document.getElementById('filtroOrden').value;

        let filtrados = this.productos.filter(p =>
          p.nombre.toLowerCase().includes(busqueda) ||
          (p.descripcion && p.descripcion.toLowerCase().includes(busqueda))
        );

        switch (orden) {
          case 'precio_asc': filtrados.sort((a, b) => a.precio - b.precio); break;
          case 'precio_desc': filtrados.sort((a, b) => b.precio - a.precio); break;
          case 'stock': filtrados.sort((a, b) => b.stock - a.stock); break;
          default: filtrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
        }

        this.mostrarProductos(filtrados);
      }

      mostrarError(mensaje) {
        const grid = document.getElementById('productosGrid');
        grid.innerHTML = `
          <div class="error-mensaje">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error al cargar productos</h3>
            <p>${mensaje}</p>
            <button onclick="productosVacuno.cargarProductosVacuno()" class="btn-agregar">Reintentar</button>
          </div>
        `;
      }
    }

    const productosVacuno = new ProductosVacuno();
  </script>
</body>
</html>
