<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Productos - Carnes Ttami√±a</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/footer.css">
  <script type="module" src="js/navbar.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* üí¨ Mensaje flotante */
    #mensaje {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #323232;
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    #mensaje.mostrar {
      opacity: 1;
    }

    /* ESTILOS PARA FORMULARIO */
    main {
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
    }

    #formProducto {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    #formProducto label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
    }

    #formProducto input,
    #formProducto select,
    #formProducto textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    
    /* Estilo especial para el input de archivo */
    #formProducto input[type="file"] {
      padding: 8px;
      background: #fff;
    }

    #formProducto button {
      background: #c00;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.3s ease;
    }

    #formProducto button:hover {
      background: #a00;
    }

    /* ESTILOS PARA LISTA DE PRODUCTOS */
    .producto-item {
      border: 1px solid #ddd;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .producto-item label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    
    .producto-item img {
        width: 100px; 
        height: 100px; 
        object-fit: cover; 
        border-radius: 5px;
        border: 1px solid #eee;
    }

    .producto-item input,
    .producto-item select,
    .producto-item textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    .producto-item textarea {
      height: 80px;
      resize: vertical;
    }

    .btn-editar {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    .btn-editar:hover {
      background: #218838;
    }

    .btn-eliminar {
      background: #b71c1c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-eliminar:hover {
      background: #9a1a1a;
    }

    .producto-item small {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

<header class="navbar">
  <div class="navbar-container">
    <div class="navbar-left">
      <h1 class="navbar-logo">Carnes Ttami√±a</h1>
      <div class="navbar-search">
        <input type="text" placeholder="Busca aqu√≠ tus productos..." />
        <button><i class="fa fa-search"></i></button>
      </div>
    </div>
    <nav class="navbar-right">
      <ul>
        <li><a href="pag_principal.html"><i class="fa fa-home"></i> Inicio</a></li>
        <li><a href="menu.html"><i class="fa fa-database"></i> Base de Datos</a></li>

        <li class="dropdown">
          <a href="#"><i class="fa fa-user"></i> Bienvenido</a>
          <ul class="dropdown-menu">
            <li><a href="#"><i class="fa fa-id-card"></i> Mi cuenta</a></li>
            <li><a href="login.html"><i class="fa fa-sign-in-alt"></i> Iniciar sesi√≥n</a></li>
            <li class="no-cuenta">¬øNo tienes cuenta?
              <a href="registro.html" class="crear-cuenta">Cr√©ala aqu√≠</a>
            </li>
          </ul>
      </ul>
    </nav>
  </div>
</header>

  <main>
    <h2>Gesti√≥n de Productos</h2>

    <section id="formulario">
      <h3>Agregar producto</h3>
      <form id="formProducto" autocomplete="off">
        <label for="nombre">Nombre del producto:</label>
        <input type="text" id="nombre" name="nombre" placeholder="Nombre del producto" required />
        
        <label for="imagen">Imagen del producto:</label>
        <input type="file" id="imagen" name="imagen" accept="image/*" required />
        
        <label for="categoria">Categor√≠a:</label>
        <select id="categoria" name="categoria" required>
          <option value="">Selecciona una categor√≠a</option>
          <option value="vacuno">üêÑ Vacuno</option>
          <option value="ave">üêî Ave</option>
          <option value="cerdo">üêñ Cerdo</option>
          <option value="Todo para el asado">ü•© Todo para el asado</option>
          <option value="packs">üì¶ Packs</option>
        </select>
        
        <label for="precio">Precio ($):</label>
        <input type="text" id="precio" name="precio" placeholder="Precio ($)" inputmode="decimal" pattern="[0-9]+([.,][0-9]+)?" required />
        
        <label for="stock">Stock:</label>
        <input type="text" id="stock" name="stock" placeholder="Stock disponible" inputmode="decimal" pattern="[0-9]+([.,][0-9]+)?" required />
        
        <label for="descripcion">Descripci√≥n:</label>
        <textarea id="descripcion" name="descripcion" placeholder="Descripci√≥n (opcional)"></textarea>
        
        <button type="submit">Guardar</button>
      </form>
    </section>

    <section id="lista">
      <h3>Lista de productos</h3>
      <div id="productos">Cargando productos...</div>
    </section>
  </main>

  <div id="mensaje"></div>

 <script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  // üîë CREDENCIALES DE SUPABASE
  const SUPABASE_URL = 'https://bagilcaibwidyewiqqzd.supabase.co'
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhZ2lsY2FpYndpZHlld2lxcXpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMjY3NDEsImV4cCI6MjA3NDYwMjc0MX0.VsVsH8c9fpjKxgmuNWYUCqE8e8DDcXicUELTexNJaAU'
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

  // üß± ELEMENTOS
  const form = document.getElementById('formProducto')
  const contenedor = document.getElementById('productos')
  const mensaje = document.getElementById('mensaje')

  function mostrarMensaje(texto, color = "green") {
    mensaje.textContent = texto
    mensaje.style.background = color === "red" ? "#b71c1c" : "#323232"
    mensaje.classList.add("mostrar")
    setTimeout(() => mensaje.classList.remove("mostrar"), 2000)
  }

  // === CARGAR PRODUCTOS ===
  async function cargarProductos() {
    const { data: productos, error } = await supabase
      .from('producto')
      .select('*')
      .order('producto_id', { ascending: true })

    if (error) {
      contenedor.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`
      return
    }

    if (!productos || productos.length === 0) {
      contenedor.innerHTML = '<p>No hay productos registrados.</p>'
      return
    }

    contenedor.innerHTML = productos.map(p => `
      <div class="producto-item" id="prod-${p.producto_id}">
        <img src="${p.imagen_url || 'https://via.placeholder.com/150?text=Sin+Imagen'}" alt="${p.nombre}">
        <br>
        <strong>${p.nombre}</strong><br>
        <small>ID: ${p.producto_id}</small><br>

        <label>Categor√≠a:</label>
        <select id="categoria-${p.producto_id}" class="categoria-editar">
          <option value="vacuno" ${p.categoria === 'vacuno' ? 'selected' : ''}>üêÑ Vacuno</option>
          <option value="ave" ${p.categoria === 'ave' ? 'selected' : ''}>üêî Ave</option>
          <option value="cerdo" ${p.categoria === 'cerdo' ? 'selected' : ''}>üêñ Cerdo</option>
          <option value="Todo para el asado" ${p.categoria === 'Todo para el asado' ? 'selected' : ''}>ü•© Miscel√°neos</option>
          <option value="packs" ${p.categoria === 'packs' ? 'selected' : ''}>üì¶ Packs</option>
        </select>
        
        <label>Precio ($):</label>
        <input type="number" id="precio-${p.producto_id}" value="${p.precio}" step="0.01">
        
        <label>Stock:</label>
        <input type="number" id="stock-${p.producto_id}" value="${p.stock}" step="0.001">
        
        <label>Descripci√≥n:</label>
        <textarea id="desc-${p.producto_id}">${p.descripcion ?? ''}</textarea>
        
        <label>Cambiar imagen (opcional):</label>
        <input type="file" id="imagen-${p.producto_id}" accept="image/*">
        
        <br><br>
        <button class="btn-editar" data-id="${p.producto_id}">‚úèÔ∏è Guardar cambios</button>
        <button class="btn-eliminar" data-id="${p.producto_id}">üóëÔ∏è Eliminar</button>
      </div>
    `).join('')

    document.querySelectorAll('.btn-editar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id
        await editarProducto(id)
      })
    })

    document.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id
        if (confirm('¬øSeguro que quieres eliminar este producto?')) {
          await eliminarProducto(id)
        }
      })
    })
  }

  // === INSERT nuevo producto ===
  form.addEventListener('submit', async (e) => {
    e.preventDefault()

    const nombre = document.getElementById('nombre').value.trim()
    const descripcion = document.getElementById('descripcion').value.trim() || null
    const precio = parseFloat(document.getElementById('precio').value.replace(',', '.')) || 0
    const stock = parseFloat(document.getElementById('stock').value.replace(',', '.')) || 0
    const categoria = document.getElementById('categoria').value
    const file = document.getElementById('imagen').files[0]

    if (!nombre) return mostrarMensaje('Ingrese un nombre', 'red')
    if (isNaN(precio) || isNaN(stock)) return mostrarMensaje('Precio o stock inv√°lido', 'red')
    if (!categoria) return mostrarMensaje('Selecciona una categor√≠a', 'red')
    if (!file) return mostrarMensaje('Debes seleccionar una imagen', 'red')

    let finalImageUrl = null
    try {
      const filePath = `public/${Date.now()}-${file.name}`

      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('imagcar')
        .upload(filePath, file, { upsert: false })

      if (uploadError) throw uploadError

      const { data: urlData } = supabase.storage.from('imagcar').getPublicUrl(filePath)
      finalImageUrl = urlData.publicUrl

    } catch (error) {
      mostrarMensaje('Error al subir la imagen: ' + error.message, 'red')
      return
    }

    const { error: insertError } = await supabase.from('producto').insert([{ 
      nombre, descripcion, precio, stock, categoria, imagen_url: finalImageUrl 
    }])

    if (insertError) return mostrarMensaje('Error: ' + insertError.message, 'red')

    mostrarMensaje('‚úÖ Producto agregado correctamente')
    form.reset()
    cargarProductos()
  })

  // === EDITAR producto ===
  async function editarProducto(id) {
    const descripcion = document.getElementById(`desc-${id}`).value.trim() || null
    const precio = parseFloat(document.getElementById(`precio-${id}`).value.replace(',', '.')) || 0
    const stock = parseFloat(document.getElementById(`stock-${id}`).value.replace(',', '.')) || 0
    const categoria = document.getElementById(`categoria-${id}`).value
    const newFile = document.getElementById(`imagen-${id}`).files[0]

    let updateObject = { descripcion, precio, stock, categoria }

    if (newFile) {
      try {
        const filePath = `public/${Date.now()}-${newFile.name}`
        const { error: uploadError } = await supabase.storage
          .from('imagcar')
          .upload(filePath, newFile, { upsert: false })
        if (uploadError) throw uploadError

        const { data: urlData } = supabase.storage.from('imagcar').getPublicUrl(filePath)
        updateObject.imagen_url = urlData.publicUrl

      } catch (error) {
        mostrarMensaje('Error al subir la nueva imagen: ' + error.message, 'red')
        return
      }
    }

    const { error } = await supabase.from('producto')
      .update(updateObject)
      .eq('producto_id', id)

    if (error) return mostrarMensaje('Error al actualizar: ' + error.message, 'red')
    mostrarMensaje('‚úÖ Cambios guardados')
    cargarProductos()
  }

  // === ELIMINAR producto ===
  async function eliminarProducto(id) {
    const { error } = await supabase.from('producto').delete().eq('producto_id', id)
    if (error) return mostrarMensaje('Error al eliminar: ' + error.message, 'red')
    mostrarMensaje('üóëÔ∏è Producto eliminado')
    cargarProductos()
  }

  cargarProductos()
</script>